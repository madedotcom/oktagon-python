name: üéÅ Release
on:
  create:
    tags:
      - v*

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - uses: actions/checkout@v2

      - name: Install poetry
        run: pipx install poetry

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
          cache: "poetry"

      - name: üêç Install dependencies
        run: make install
        
      - name: Get tag version
        id: get-version
        run: |
          echo '::echo::on'
          set +e
          echo ::set-output name=version::${{github.ref_name}}

      - name: Build project for distribution
        run: make build
      
      - name: Bump the version
        run: |
          make release RELEASE_VERSION=${{github.ref_name}}
  
      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "dist/*"
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: true # TODO remove after testing...

      - name: üì¶ Publish to PyPI
        env:
          OKTAGON_PYPI_TOKEN: ${{ secrets.OKTAGON_PYPI_TOKEN }}
        run: make publish
